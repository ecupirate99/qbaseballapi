<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Baseball Museum Stats Explorer</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>âš¾ Baseball Museum Stats Explorer</h1>
    <p>Explore legendary players by stats, birthplace, and era</p>
  </header>

  <!-- Stat Filters -->
  <section class="filters">
    <h2>Stat Leaders</h2>
    <div class="filter-group">
      <label for="stat">Choose Stat:</label>
      <select id="stat">
        <option value="HR">Home Runs</option>
        <option value="BA">Batting Average</option>
        <option value="SLG">Slugging %</option>
        <option value="OPS">OPS</option>
        <option value="WAR">WAR</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="limit">Top N:</label>
      <input type="number" id="limit" value="10">
    </div>

    <button onclick="runStatQuery()">Search Stat Leaders</button>
  </section>

  <!-- City Search -->
  <section class="filters">
    <h2>Search by City</h2>
    <div class="filter-group">
      <label for="city">Birthplace:</label>
      <input type="text" id="city" placeholder="e.g. Charlotte">
    </div>
    <button onclick="runCityQuery()">Search Players by City</button>
  </section>

  <!-- Pitching Filters -->
  <section class="filters">
    <h2>Pitching Leaders</h2>
    <div class="filter-group">
      <label for="minIP">Min IP:</label>
      <input type="number" id="minIP" value="100">
    </div>
    <button onclick="runPitchingQuery()">Search Pitching Leaders</button>
  </section>

  <!-- Milestone Clubs -->
  <section class="milestones">
    <h2>Milestone Clubs</h2>
    <button onclick="runMilestone('HR', 500)">500+ HR Club</button>
    <button onclick="runMilestone('H', 3000)">3000 Hits Club</button>
    <button onclick="runMilestone('W', 300)">300 Wins Club</button>
  </section>

  <section id="results">
    <div id="output"></div>
  </section>

  <script>
    async function runStatQuery() {
      const stat = document.getElementById('stat').value;
      const limit = document.getElementById('limit').value;
      let url = `/.netlify/functions/query?query=topStat&stat=${stat}&limit=${limit}`;
      fetchAndRender(url);
    }

    async function runCityQuery() {
      const city = document.getElementById('city').value;
      if (!city) {
        document.getElementById("output").innerHTML = "<p>Please enter a city.</p>";
        return;
      }
      let url = `/.netlify/functions/query?query=playersFromCity&city=${encodeURIComponent(city)}`;
      fetchAndRender(url);
    }

    async function runPitchingQuery() {
      const minIP = document.getElementById('minIP').value;
      let url = `/.netlify/functions/query?query=lowestERA&minIP=${minIP}`;
      fetchAndRender(url);
    }

    async function runMilestone(stat, threshold) {
      let url = `/.netlify/functions/query?query=topStat&stat=${stat}&limit=200`;
      try {
        const response = await fetch(url);
        const data = await response.json();
        const filtered = data.filter(player => player[stat] >= threshold);
        renderTable(filtered);
      } catch (err) {
        document.getElementById("output").textContent = "Error: " + err.message;
      }
    }

    async function fetchAndRender(url) {
      try {
        const response = await fetch(url);
        const data = await response.json();
        renderTable(data);
      } catch (err) {
        document.getElementById("output").textContent = "Error: " + err.message;
      }
    }

    function renderTable(data) {
      if (Array.isArray(data) && data.length > 0) {
        let table = "<table id='outputTable'><thead><tr>";
        const keys = Object.keys(data[0]);
        keys.forEach(k => table += `<th>${k}</th>`);
        table += "</tr></thead><tbody>";

        data.forEach(row => {
          table += "<tr>";
          keys.forEach(k => {
            let val = row[k];
            if (k === "BA" && val != null) {
              val = parseFloat(val).toFixed(3);
              if (val.startsWith("0")) val = val.substring(1);
            }
            table += `<td>${val}</td>`;
          });
          table += "</tr>";
        });

        table += "</tbody></table>";
        document.getElementById("output").innerHTML = table;
        makeTableSortable("outputTable");
      } else {
        document.getElementById("output").innerHTML = "<p>No results found.</p>";
      }
    }

    function makeTableSortable(tableId) {
      const table = document.getElementById(tableId);
      const headers = table.querySelectorAll("th");
      headers.forEach((header, index) => {
        header.addEventListener("click", () => {
          const rows = Array.from(table.querySelectorAll("tbody tr"));
          const asc = header.classList.toggle("asc");
          rows.sort((a, b) => {
            const valA = a.children[index].innerText;
            const valB = b.children[index].innerText;
            const numA = parseFloat(valA) || valA;
            const numB = parseFloat(valB) || valB;
            return asc ? (numA > numB ? 1 : -1) : (numA < numB ? 1 : -1);
          });
          rows.forEach(row => table.querySelector("tbody").appendChild(row));
        });
      });
    }
  </script>
</body>
</html>
